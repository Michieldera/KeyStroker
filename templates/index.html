<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyStroker - Keyboard Automation</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- SortableJS via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-row">
                <div class="header-title">
                    <h1>KeyStroker</h1>
                    <p class="subtitle">Visual Keyboard Automation Builder</p>
                </div>
                <div class="header-actions">
                    <div class="version-info">
                        <span class="version-label" id="versionDisplay">v1.0.0</span>
                        <button class="update-check-btn" id="checkUpdateBtn" title="Check for updates">
                            &#x21bb; Updates
                        </button>
                    </div>
                    <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                        <span class="theme-icon-light">&#9788;</span>
                        <span class="theme-icon-dark">&#9790;</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Saved Patterns Section (Collapsible) -->
        <section class="patterns-section">
            <div class="patterns-header" id="patternsToggle">
                <h2>Saved Patterns (<span id="patternCount">0</span>)</h2>
                <button class="toggle-btn" id="togglePatternsBtn">
                    <span class="toggle-icon">&#9660;</span>
                </button>
            </div>
            <div class="patterns-content" id="patternsContent">
                <div class="patterns-grid" id="patternsGrid">
                    <!-- Pattern cards will be populated here -->
                    <div class="empty-patterns" id="emptyPatterns">
                        <p>No saved patterns yet. Create and save your first pattern!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Target Application Section -->
        <section class="target-section">
            <h2>Target Application</h2>
            <div class="target-options">
                <label class="radio-option">
                    <input type="radio" name="targetMode" value="auto" id="targetModeAuto">
                    <span>Auto-focus window:</span>
                </label>
                <div class="window-selector">
                    <select id="windowSelect" disabled>
                        <option value="">Select a window...</option>
                    </select>
                    <button class="icon-btn" id="refreshWindowsBtn" title="Refresh window list">
                        &#x21bb;
                    </button>
                </div>
                <label class="radio-option">
                    <input type="radio" name="targetMode" value="manual" id="targetModeManual" checked>
                    <span>Manual mode (switch apps during start delay)</span>
                </label>
            </div>
        </section>

        <!-- Settings Section -->
        <section class="settings-section">
            <h2>Settings</h2>
            <div class="settings-row">
                <div class="setting-group">
                    <label for="loopCount">Loop Count:</label>
                    <input type="number" id="loopCount" value="1" min="1" max="1000">
                </div>
                <div class="setting-group">
                    <label for="startDelay">Start Delay:</label>
                    <input type="number" id="startDelay" value="3" min="0" max="60">
                    <span class="unit">seconds</span>
                </div>
                <div class="setting-group">
                    <label for="defaultDelay">Default Delay:</label>
                    <input type="number" id="defaultDelay" value="0.1" min="0" max="10" step="0.01">
                    <span class="unit">sec</span>
                    <button class="btn-small" id="applyDefaultDelay" title="Apply to all items in sequence">Apply All</button>
                </div>
            </div>
        </section>

        <!-- Action Buttons -->
        <section class="actions-section">
            <button class="btn btn-primary" id="runBtn">
                <i data-lucide="play" class="btn-icon"></i> Run Sequence
            </button>
            <button class="btn btn-secondary" id="savePatternBtn">
                <i data-lucide="save" class="btn-icon"></i> Save Pattern
            </button>
            <button class="btn btn-secondary" id="loadJsonBtn">
                <i data-lucide="folder-open" class="btn-icon"></i> Load JSON
            </button>
            <button class="btn btn-secondary" id="exportJsonBtn">
                <i data-lucide="download" class="btn-icon"></i> Export JSON
            </button>
            <div class="btn-group">
                <button class="btn btn-outline" id="undoBtn" disabled title="Nothing to undo">
                    <i data-lucide="undo-2" class="btn-icon"></i> Undo
                </button>
                <button class="btn btn-outline" id="redoBtn" disabled title="Nothing to redo">
                    <i data-lucide="redo-2" class="btn-icon"></i> Redo
                </button>
            </div>
            <button class="btn btn-danger" id="clearSequenceBtn">
                <i data-lucide="trash-2" class="btn-icon"></i> Clear All
            </button>
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
        </section>

        <!-- Main Content: Toolbox and Sequence -->
        <main class="main-content">
            <!-- Toolbox Panel -->
            <aside class="toolbox-panel">
                <h2>Toolbox</h2>
                <p class="panel-hint">Drag items to the sequence</p>
                
                <div class="toolbox-items" id="toolbox">
                    <!-- Type Text -->
                    <div class="toolbox-item" data-action="type">
                        <div class="item-header">
                            <i data-lucide="text-cursor-input" class="item-icon"></i>
                            <span class="item-title">Type Text</span>
                        </div>
                        <div class="item-fields">
                            <input type="text" class="field-text" placeholder="Enter text... (use {i} for loop #)" data-field="value">
                            <div class="field-row">
                                <label>Speed:</label>
                                <input type="number" class="field-number" value="0" min="0" max="1" step="0.01" data-field="interval">
                                <span class="unit">sec</span>
                            </div>
                        </div>
                    </div>

                    <!-- Type Number Range -->
                    <div class="toolbox-item" data-action="type_range">
                        <div class="item-header">
                            <i data-lucide="hash" class="item-icon"></i>
                            <span class="item-title">Type Number Range</span>
                        </div>
                        <div class="item-fields">
                            <div class="field-row">
                                <label>From:</label>
                                <input type="number" class="field-number" value="1" data-field="start">
                                <label>To:</label>
                                <input type="number" class="field-number" value="10" data-field="end">
                            </div>
                            <div class="field-row">
                                <label>Speed:</label>
                                <input type="number" class="field-number" value="0" min="0" max="1" step="0.01" data-field="interval">
                                <span class="unit">sec</span>
                            </div>
                            <div class="field-row">
                                <label class="checkbox-inline">
                                    <input type="checkbox" data-field="use_padding" class="padding-toggle">
                                    Min digits:
                                </label>
                                <input type="number" class="field-number" value="2" min="1" max="10" data-field="min_digits" disabled style="width: 50px;">
                            </div>
                        </div>
                    </div>

                    <!-- Press Key -->
                    <div class="toolbox-item" data-action="key">
                        <div class="item-header">
                            <i data-lucide="keyboard" class="item-icon"></i>
                            <span class="item-title">Press Key</span>
                        </div>
                        <div class="item-fields">
                            <select class="field-select" data-field="value">
                                <option value="">Select key...</option>
                                <optgroup label="Navigation">
                                    <option value="tab">Tab</option>
                                    <option value="enter">Enter</option>
                                    <option value="escape">Escape</option>
                                    <option value="space">Space</option>
                                    <option value="backspace">Backspace</option>
                                    <option value="delete">Delete</option>
                                </optgroup>
                                <optgroup label="Arrow Keys">
                                    <option value="up">Up</option>
                                    <option value="down">Down</option>
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                </optgroup>
                                <optgroup label="Function Keys">
                                    <option value="f1">F1</option>
                                    <option value="f2">F2</option>
                                    <option value="f3">F3</option>
                                    <option value="f4">F4</option>
                                    <option value="f5">F5</option>
                                    <option value="f6">F6</option>
                                    <option value="f7">F7</option>
                                    <option value="f8">F8</option>
                                    <option value="f9">F9</option>
                                    <option value="f10">F10</option>
                                    <option value="f11">F11</option>
                                    <option value="f12">F12</option>
                                </optgroup>
                                <optgroup label="Modifiers">
                                    <option value="ctrl">Ctrl</option>
                                    <option value="alt">Alt</option>
                                    <option value="shift">Shift</option>
                                    <option value="win">Win</option>
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="home">Home</option>
                                    <option value="end">End</option>
                                    <option value="pageup">Page Up</option>
                                    <option value="pagedown">Page Down</option>
                                    <option value="insert">Insert</option>
                                    <option value="printscreen">Print Screen</option>
                                    <option value="capslock">Caps Lock</option>
                                    <option value="numlock">Num Lock</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <!-- Hotkey Combo -->
                    <div class="toolbox-item" data-action="hotkey">
                        <div class="item-header">
                            <i data-lucide="zap" class="item-icon"></i>
                            <span class="item-title">Hotkey Combo</span>
                        </div>
                        <div class="item-fields">
                            <div class="hotkey-selects">
                                <select class="field-select hotkey-select" data-field="key1">
                                    <option value="ctrl">Ctrl</option>
                                    <option value="alt">Alt</option>
                                    <option value="shift">Shift</option>
                                    <option value="win">Win</option>
                                </select>
                                <span class="hotkey-plus">+</span>
                                <select class="field-select hotkey-select" data-field="key2">
                                    <option value="">Select key...</option>
                                    <optgroup label="Navigation">
                                        <option value="tab">Tab</option>
                                        <option value="enter">Enter</option>
                                        <option value="escape">Escape</option>
                                        <option value="space">Space</option>
                                        <option value="backspace">Backspace</option>
                                        <option value="delete">Delete</option>
                                    </optgroup>
                                    <optgroup label="Arrow Keys">
                                        <option value="up">Up</option>
                                        <option value="down">Down</option>
                                        <option value="left">Left</option>
                                        <option value="right">Right</option>
                                    </optgroup>
                                    <optgroup label="Letters">
                                        <option value="a">A</option>
                                        <option value="b">B</option>
                                        <option value="c">C</option>
                                        <option value="d">D</option>
                                        <option value="e">E</option>
                                        <option value="f">F</option>
                                        <option value="g">G</option>
                                        <option value="h">H</option>
                                        <option value="i">I</option>
                                        <option value="j">J</option>
                                        <option value="k">K</option>
                                        <option value="l">L</option>
                                        <option value="m">M</option>
                                        <option value="n">N</option>
                                        <option value="o">O</option>
                                        <option value="p">P</option>
                                        <option value="q">Q</option>
                                        <option value="r">R</option>
                                        <option value="s">S</option>
                                        <option value="t">T</option>
                                        <option value="u">U</option>
                                        <option value="v">V</option>
                                        <option value="w">W</option>
                                        <option value="x">X</option>
                                        <option value="y">Y</option>
                                        <option value="z">Z</option>
                                    </optgroup>
                                    <optgroup label="Numbers">
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                    </optgroup>
                                    <optgroup label="Function Keys">
                                        <option value="f1">F1</option>
                                        <option value="f2">F2</option>
                                        <option value="f3">F3</option>
                                        <option value="f4">F4</option>
                                        <option value="f5">F5</option>
                                        <option value="f6">F6</option>
                                        <option value="f7">F7</option>
                                        <option value="f8">F8</option>
                                        <option value="f9">F9</option>
                                        <option value="f10">F10</option>
                                        <option value="f11">F11</option>
                                        <option value="f12">F12</option>
                                    </optgroup>
                                    <optgroup label="Other">
                                        <option value="home">Home</option>
                                        <option value="end">End</option>
                                        <option value="pageup">Page Up</option>
                                        <option value="pagedown">Page Down</option>
                                        <option value="insert">Insert</option>
                                        <option value="printscreen">Print Screen</option>
                                        <option value="capslock">Caps Lock</option>
                                        <option value="numlock">Num Lock</option>
                                    </optgroup>
                                </select>
                            </div>
                            <button class="btn-small add-key-btn" type="button">+ Add Key</button>
                        </div>
                    </div>

                    <!-- Wait -->
                    <div class="toolbox-item" data-action="wait">
                        <div class="item-header">
                            <i data-lucide="clock" class="item-icon"></i>
                            <span class="item-title">Wait</span>
                        </div>
                        <div class="item-fields">
                            <div class="field-row">
                                <label>Duration:</label>
                                <input type="number" class="field-number" value="0.5" min="0" max="60" step="0.1" data-field="value">
                                <span class="unit">sec</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mouse Click -->
                    <div class="toolbox-item" data-action="click">
                        <div class="item-header">
                            <i data-lucide="mouse-pointer-click" class="item-icon"></i>
                            <span class="item-title">Mouse Click</span>
                        </div>
                        <div class="item-fields">
                            <div class="field-row">
                                <label>Button:</label>
                                <select class="field-select" data-field="button" style="width: auto; min-width: 80px;">
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                    <option value="middle">Middle</option>
                                </select>
                                <label>Clicks:</label>
                                <select class="field-select" data-field="clicks" style="width: auto; min-width: 60px;">
                                    <option value="1">1</option>
                                    <option value="2">2 (Double)</option>
                                    <option value="3">3 (Triple)</option>
                                </select>
                            </div>
                            <div class="field-row">
                                <label class="checkbox-inline">
                                    <input type="checkbox" data-field="use_coords" class="coords-toggle">
                                    Click at coordinates:
                                </label>
                            </div>
                            <div class="field-row coords-fields" style="display: none;">
                                <label>X:</label>
                                <input type="number" class="field-number" value="0" min="0" data-field="x">
                                <label>Y:</label>
                                <input type="number" class="field-number" value="0" min="0" data-field="y">
                                <button type="button" class="btn-small pick-coords-btn" title="Pick from screen">Pick</button>
                            </div>
                        </div>
                    </div>

                    <!-- Move Mouse -->
                    <div class="toolbox-item" data-action="move_mouse">
                        <div class="item-header">
                            <i data-lucide="move" class="item-icon"></i>
                            <span class="item-title">Move Mouse</span>
                        </div>
                        <div class="item-fields">
                            <div class="field-row">
                                <label>X:</label>
                                <input type="number" class="field-number" value="0" min="0" data-field="x">
                                <label>Y:</label>
                                <input type="number" class="field-number" value="0" min="0" data-field="y">
                            </div>
                            <div class="field-row">
                                <label>Duration:</label>
                                <input type="number" class="field-number" value="0" min="0" max="10" step="0.1" data-field="duration">
                                <span class="unit">sec</span>
                                <button type="button" class="btn-small pick-coords-btn" title="Pick from screen">Pick</button>
                            </div>
                        </div>
                    </div>

                    <!-- Repeat Block -->
                    <div class="toolbox-item repeat-block-item" data-action="repeat">
                        <div class="item-header">
                            <i data-lucide="repeat" class="item-icon"></i>
                            <span class="item-title">Repeat Block</span>
                        </div>
                        <div class="item-fields">
                            <div class="field-row">
                                <label>Times:</label>
                                <input type="number" class="field-number" value="1" min="1" max="100" data-field="times">
                            </div>
                            <div class="field-row">
                                <label>Delay:</label>
                                <input type="number" class="field-number" value="0" min="0" max="10" step="0.05" data-field="delay">
                                <span class="unit">sec</span>
                            </div>
                            <div class="repeat-dropzone" data-field="children">
                                <div class="repeat-empty">Drop actions here</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Sequence Panel -->
            <section class="sequence-panel">
                <h2>Sequence</h2>
                <p class="panel-hint">Drag, drop, and reorder your automation steps</p>
                
                <!-- Tab Bar -->
                <div class="sequence-tabs">
                    <button class="sequence-tab" data-tab="startup">
                        &#128640; Startup (Once)
                    </button>
                    <button class="sequence-tab active" data-tab="main">
                        &#128257; Main Loop
                    </button>
                </div>
                
                <!-- Startup Sequence Dropzone -->
                <div class="sequence-dropzone" id="startupSequence" style="display: none;">
                    <div class="empty-sequence" id="emptyStartup">
                        <div class="empty-icon">&#128640;</div>
                        <p>Drag items here for one-time startup actions</p>
                        <p class="empty-hint">These run once before the main loop begins</p>
                    </div>
                </div>
                
                <!-- Main Sequence Dropzone -->
                <div class="sequence-dropzone" id="sequence">
                    <div class="empty-sequence" id="emptySequence">
                        <div class="empty-icon">&#128203;</div>
                        <p>Drag items here to build your sequence</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p><strong>Safety:</strong> Move your mouse to the top-left corner of the screen to emergency stop!</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Confirm Execution</h3>
            </div>
            <div class="modal-body">
                <div class="confirm-details">
                    <p><strong>Target:</strong> <span id="confirmTarget">-</span></p>
                    <p><strong>Startup Steps:</strong> <span id="confirmStartupSteps">-</span></p>
                    <p><strong>Loop Steps:</strong> <span id="confirmSteps">-</span></p>
                    <p><strong>Loops:</strong> <span id="confirmLoops">-</span></p>
                    <p><strong>Start Delay:</strong> <span id="confirmDelay">-</span> seconds</p>
                </div>
                <div class="safety-warning">
                    <span class="warning-icon">&#9889;</span>
                    <p><strong>EMERGENCY STOP:</strong> Move mouse to top-left corner!</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirmCancel">Cancel</button>
                <button class="btn btn-primary" id="confirmRun">
                    <span class="btn-icon">&#9658;</span> Run Sequence
                </button>
            </div>
        </div>
    </div>

    <!-- Save Pattern Modal -->
    <div class="modal-overlay" id="savePatternModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Save Pattern</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="patternName">Pattern Name: *</label>
                    <input type="text" id="patternName" placeholder="Enter pattern name...">
                </div>
                <div class="form-group">
                    <label for="patternDescription">Description (optional):</label>
                    <textarea id="patternDescription" rows="3" placeholder="Describe what this pattern does..."></textarea>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeSettings" checked>
                        Include current settings (target, loops, delay)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="savePatternCancel">Cancel</button>
                <button class="btn btn-primary" id="savePatternConfirm">
                    <span class="btn-icon">&#128190;</span> Save Pattern
                </button>
            </div>
        </div>
    </div>

    <!-- Overwrite Confirmation Modal -->
    <div class="modal-overlay" id="overwriteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Pattern Exists</h3>
            </div>
            <div class="modal-body">
                <p>A pattern named "<span id="overwritePatternName"></span>" already exists.</p>
                <p>Do you want to overwrite it?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="overwriteCancel">Cancel</button>
                <button class="btn btn-warning" id="overwriteConfirm">Overwrite</button>
            </div>
        </div>
    </div>

    <!-- Unsaved Changes Modal -->
    <div class="modal-overlay" id="unsavedModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Unsaved Changes</h3>
            </div>
            <div class="modal-body">
                <p>Your current sequence has unsaved changes.</p>
                <p>Loading a pattern will replace your current work.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="unsavedCancel">Cancel</button>
                <button class="btn btn-warning" id="unsavedConfirm">Load Anyway</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Pattern</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deletePatternName"></span>"?</p>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="deleteCancel">Cancel</button>
                <button class="btn btn-danger" id="deleteConfirm">Delete</button>
            </div>
        </div>
    </div>

    <!-- Clear Sequence Confirmation Modal -->
    <div class="modal-overlay" id="clearModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Clear Sequence?</h3>
            </div>
            <div class="modal-body">
                <p>This will remove all items from the sequence.</p>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="clearCancel">Cancel</button>
                <button class="btn btn-danger" id="clearConfirm">
                    <span class="btn-icon">&#128465;</span> Clear All
                </button>
            </div>
        </div>
    </div>

    <!-- Countdown/Execution Overlay -->
    <div class="execution-overlay" id="executionOverlay">
        <div class="execution-content">
            <div class="countdown-display" id="countdownDisplay">
                <div class="countdown-label">Starting in...</div>
                <div class="countdown-number" id="countdownNumber">3</div>
                <div class="countdown-hint">Move mouse to top-left corner to stop</div>
            </div>
            <div class="execution-progress" id="executionProgress" style="display: none;">
                <div class="progress-icon">&#9658;</div>
                <div class="progress-label">Running sequence...</div>
                <div class="progress-details">
                    <span>Loop <span id="currentLoop">1</span> of <span id="totalLoops">1</span></span>
                    <span class="progress-sep">|</span>
                    <span>Step <span id="currentStep">1</span> of <span id="totalSteps">1</span></span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-hint">Move mouse to top-left corner to stop</div>
            </div>
        </div>
    </div>

    <!-- Update Available Modal -->
    <div class="modal-overlay" id="updateModal">
        <div class="modal">
            <div class="modal-header">
                <h3>&#127881; Update Available!</h3>
            </div>
            <div class="modal-body">
                <div class="update-info">
                    <p class="update-version-comparison">
                        <span class="current-version">Current: <strong id="updateCurrentVersion">v1.0.0</strong></span>
                        <span class="version-arrow">&#8594;</span>
                        <span class="new-version">New: <strong id="updateNewVersion">v1.1.0</strong></span>
                    </p>
                    <p class="release-name" id="updateReleaseName"></p>
                    <div class="release-notes" id="updateReleaseNotes"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="updateLater">Later</button>
                <a href="#" class="btn btn-primary" id="updateDownloadBtn" target="_blank">
                    &#128229; Download Update
                </a>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon"></span>
        <span class="toast-message" id="toastMessage"></span>
    </div>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="/static/script.js"></script>
    <script>
        // Initialize Lucide icons after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
